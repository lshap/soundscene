
<!DOCTYPE HTML>
<html>
	<head>

		<link rel="stylesheet" type="text/css" href="soundscene.css"/>
		<script type="text/javascript" src="js/pitch.js"></script>
		<script src="https://rawgithub.com/mrdoob/three.js/master/build/three.js"></script>
		<script src="js/jquery-1.11.0.min.js"></script>
		<script type="text/javascript">
			ColorMode = {
				MONOCHROME: 0,
				TWOTONE: 1
			};

			ShapeMode = {
				CIRCLE: 0,
				SQUARE: 1,
				SKEW: 2
			};

			GridMode = {
				RIGID: 0,
				CONCENTRIC: 1
			};


			var audioContext;
			var audioSource;
			var analyser;
			var freqDomain;
			var timeDomain;
			var canvas;
			var ctxt;
			var GRID_WIDTH = 32;
			var GRID_HEIGHT = 32;
			var SAMPLE_MAX = 256;
			var WIDTH = window.innerWidth * 0.8;
			var HEIGHT =window.innerHeight * 0.8;
			var lastAmps;
			var frame = 0;
			var colormode = ColorMode.TWOTONE;
			var shapemode = ShapeMode.SQUARE;
			var gridmode = GridMode.RIGID;

	
			function init() {
				canvas = document.getElementById('canvas'); 
				ctxt = canvas.getContext('2d');	
				canvas.width = WIDTH;
				canvas.height = HEIGHT;
				$('#canvas').hide();

				try {
					// Fix up for prefixing
					window.AudioContext = window.AudioContext
							      ||window.webkitAudioContext;
					 audioContext = new AudioContext();
				}
				 catch(e) {
					alert('Web Audio API is not supported in this browser');
				}
				
				ctxt.strokeRect(0, 0, canvas.width, canvas.height);	
			}
			
			// load sound from input mp3
			function loadSound(file) {
				var reader = new FileReader();
				reader.onload = function(e) {
					var buff = e.target.result;
					playSound(buff);
				}				
				
				reader.readAsArrayBuffer(file);
			}

			function analyzeSound() {
				requestAnimationFrame(analyzeSound);
//				console.log('analyzing...');
				if (frame % 10 != 0) {
					frame ++;
					return;
				}
				var timeDomain = new Uint8Array(analyser.frequencyBinCount);
				analyser.getByteTimeDomainData(timeDomain);
			
				var freqDomain = new Float32Array(analyser.frequencyBinCount);

				analyser.getFloatFrequencyData(freqDomain);
				ctxt.clearRect(0,0, WIDTH, HEIGHT);
				for (var freq = 0; freq < freqDomain.length; freq++) {
					var x, y, r;
					var amp = freqDomain[freq];

					switch(gridmode) {
						case GridMode.RIGID:
							x = Math.floor(freq % GRID_WIDTH) * WIDTH/GRID_WIDTH + 10;
							y = Math.floor(freq / GRID_WIDTH) * HEIGHT/GRID_HEIGHT + 10;
							r = Math.abs(amp/SAMPLE_MAX) * 30;	
						break;
						case GridMode.CONCENTRIC:
							x = WIDTH/2;
							y = HEIGHT/2;
							r = Math.abs(Math.pow(amp/SAMPLE_MAX, 2)) * WIDTH/4; 
						break;
						default:
							x = Math.floor(freq % GRID_WIDTH) * WIDTH/GRID_WIDTH + 10;
							y = Math.floor(freq / GRID_WIDTH) * HEIGHT/GRID_HEIGHT + 10;
							r = Math.abs(amp/SAMPLE_MAX) * 30;	
					}

					
					var lastamp = lastAmps[freq];
					var delta = (lastamp - amp);
					
					switch (colormode) {
						case ColorMode.MONOCHROMATIC:
							ctxt.fillStyle = 'rgba(0, 255, 0,' + r/30 * 0.9 + ')';
						break;					
						case ColorMode.TWOTONE:
							if (delta > 1) {
								ctxt.fillStyle = 'rgba(255 ,255, 0,' + r/30 * 0.9 + ')';
							}
							else {
								ctxt.fillStyle = 'rgba(0, 255, 0,' + r/30 * 0.9 + ')';
							}
						break;					
						default:
							ctxt.fillStyle = 'rgba(0, 255, 0,' + r/30 * 0.9 + ')';
					}

					switch (shapemode) {
						case ShapeMode.CIRCLE:
							ctxt.beginPath();
							ctxt.arc(x, y, r, 0, Math.PI * 2);
							ctxt.fill();
						break;	
						case ShapeMode.SQUARE:
							ctxt.beginPath();
							ctxt.rotate(frame % 2 * Math.PI);
							ctxt.rect(x - r, y-r, r * 2, r * 2);
							ctxt.fill();
						break;	
						case ShapeMode.SKEW:
							ctxt.beginPath();
							ctxt.arc(x, y, r, 0, Math.PI * 2);
							ctxt.fill();
						break;	
						default:
							ctxt.beginPath();
							ctxt.arc(x, y, r, 0, Math.PI * 2);
							ctxt.fill();
					}
				}

				lastAmps = freqDomain;
				frame++;
			}

			// play sound from ArrayBuffer
			function playSound(buffer) {
				// disconnect if there is already a song uploaded
				if (audioSource) {
					audioSource.stop();
					audioSource.disconnect(0);
				}
				
				audioSource = audioContext.createBufferSource();
				
				try {
					audioSource.buffer = audioContext.createBuffer(buffer,false);
				} catch (e) {
					console.log("error reading sound file");
					return;
				}				
				
				$('h1').hide();
				$('#dragDiv').hide();
				$('#canvas').show();
				// set up the AudioAnalserNode
				analyser = audioContext.createAnalyser();
				audioSource.connect(analyser);

				lastAmps = new Float32Array(analyser.frequencyBinCount);

				analyser.connect(audioContext.destination);
				audioSource.connect(audioContext.destination);
		 
				audioSource.start(0);
				analyzeSound();
			}		
			
			function allowDrop(ev) {
//				console.log('registered drag');
				ev.preventDefault();
			}
			
			function drop(ev) {
				ev.preventDefault();
				var data = ev.dataTransfer.files[0];	
				if (data) {
					loadSound(data);
				}
			}

			$(document).ready(function() {

				init();
			});	
		</script>
	</head>

	<body>
		<h1>Sound Scene</h1>
		<div id="dragDiv" ondragover="allowDrop(event)" ondrop="drop(event)"><span> drag sound here </span></div>
		<canvas id="canvas"></canvas>
	</body>
</html>
