
<!DOCTYPE HTML>
<html>
	<head>

		<link rel="stylesheet" type="text/css" href="soundscene.css"/>
		<script type="text/javascript" src="js/pitch.js"></script>
		<script src="https://rawgithub.com/mrdoob/three.js/master/build/three.js"></script>
		<script src="js/jquery-1.11.0.min.js"></script>
		<script type="text/javascript">
			ColorMode = {
				MONOCHROME: 0,
				TWOTONE: 1,
				THREETONE: 2,
				GRADIENT: 3,
				RANDOM: 4
			};

			ShapeMode = {
				CIRCLE: 0,
				SQUARE: 1,
				SKEW: 2
			};

			GridMode = {
				RIGID: 0,
				CONCENTRIC: 1,
				RANDOM: 2,
				SPIRAL: 3,
				REVERSESPIRAL: 4,
				BUTTERFLY:5,
				ASTROID:6,
				EPICYCLOID:7,
				REVERSEEPIC:8,
				HYPOTROCHOID: 9,
			};


			var audioContext;
			var audioSource;
			var analyser;
			var freqDomain;
			var timeDomain;
			var canvas;
			var ctxt;
			var GRID_WIDTH = 32;
			var GRID_HEIGHT = 32;
			var SAMPLE_MAX = 256;
			var WIDTH = window.innerWidth * 0.8;
			var HEIGHT =window.innerHeight * 0.8;
			var lastAmps;
			var frame = 0;
			var colormode = ColorMode.THREETONE;
			var shapemode = ShapeMode.CIRCLE;
			var gridmode = GridMode.SPIRAL;
			var interp = 0;

			function init() {
				canvas = document.getElementById('canvas'); 
				ctxt = canvas.getContext('2d');	
				canvas.width = WIDTH;
				canvas.height = HEIGHT;
				console.log('width = ' + WIDTH + 'height = ' + HEIGHT);
				$('#canvas').hide();
				$('#wavedistortion').hide();

				try {
					// Fix up for prefixing
					window.AudioContext = window.AudioContext
							      ||window.webkitAudioContext;
					 audioContext = new AudioContext();
				}
				 catch(e) {
					alert('Web Audio API is not supported in this browser');
				}
				
				ctxt.strokeRect(0, 0, canvas.width, canvas.height);	
			}
			
			// load sound from input mp3
			function loadSound(file) {
				var reader = new FileReader();
				reader.onload = function(e) {
					var buff = e.target.result;
					playSound(buff);
				}				
				
				reader.readAsArrayBuffer(file);
			}

			function analyzeSound() {
				requestAnimationFrame(analyzeSound);
//				console.log('analyzing...');
				if (frame % 10 != 0 && colormode != ColorMode.MONOTONE) {
					frame ++;
					return;
				}
				var timeDomain = new Uint8Array(analyser.frequencyBinCount);
				analyser.getByteTimeDomainData(timeDomain);
			
				var max = 0;
			/*	for (var i = 0; i < timeDomain.length; i++) {
					if (timeDomain[i] > max) {
						max = timeDomain[i];
					}
				}

				console.log('max = ' + max);*/
	
				var freqDomain = new Float32Array(analyser.frequencyBinCount);

				analyser.getFloatFrequencyData(freqDomain);
				ctxt.clearRect(0,0, WIDTH, HEIGHT);
				for (var freq = 0; freq < freqDomain.length; freq++) {
					var x, y, r;
					var amp = freqDomain[freq];
	
					switch(gridmode) {
						case GridMode.RIGID:
							x = Math.floor(freq % GRID_WIDTH) * WIDTH/GRID_WIDTH + 10;
							y = Math.floor(freq / GRID_WIDTH) * HEIGHT/GRID_HEIGHT + 10;
							r = Math.abs(amp/SAMPLE_MAX) * 30;	
						break;
						case GridMode.CONCENTRIC:
							x = WIDTH/2;
							y = HEIGHT/2;
							r = Math.abs(Math.pow(amp/SAMPLE_MAX, 2)) * WIDTH/4; 
						break;
						case GridMode.RANDOM:
							x = Math.random() * WIDTH;
							y = Math.random() * HEIGHT;
							r = Math.abs(Math.pow(amp/SAMPLE_MAX, 2)) * 50; 
						break;
						case GridMode.SPIRAL:
							x = 0.2 * freq * Math.cos(freq) + WIDTH/2; 
							y =  0.2 * freq * Math.sin(freq) + HEIGHT/2;
							r = Math.abs(Math.pow(amp/SAMPLE_MAX, 2)) * 50; 
						break;
						case GridMode.REVERSESPIRAL:
							var rev = 1024 - freq;
							x = 0.3 * rev * Math.cos(rev) + WIDTH/2; 
							y =  0.3 * rev * Math.sin(rev) + HEIGHT/2;
							r = Math.abs(Math.pow(amp/SAMPLE_MAX, 2)) * 50; 
						break;
						case GridMode.BUTTERFLY:
							var cosf = Math.cos(freq);
							var sinf12 = Math.sin(freq/12);
							var ecosf = Math.pow(Math.E, cosf);
							var mult = (ecosf - 2 * Math.cos(4 * freq) - Math.pow(sinf12, 5));

							x = 70 * Math.sin(freq) * mult + WIDTH/2;
							y = 50 * Math.cos(freq) * mult + HEIGHT/2;
							r = Math.abs(Math.pow(amp/SAMPLE_MAX, 2)) * 50; 
						break;
						case GridMode.ASTROID:
							x = 300 *(freq/1024)* Math.pow(Math.cos(freq), 3) + WIDTH/2 ;
							y = 240 *(freq/1024)* Math.pow(Math.sin(freq), 3) + HEIGHT/2;
							r = Math.abs(Math.pow(amp/SAMPLE_MAX, 2)) * 50; 
						break;
						case GridMode.EPICYCLOID:
							var a = freq/1024 * 200;
							var rev = 1024 - freq;
							var b = a/7; 
							var revx =  (a + b) * Math.cos(rev) - b * Math.cos((a / b + 1)*rev);
							var revy =  (a + b) * Math.sin(rev) - b * Math.sin((a / b + 1)*rev);
							
							x = (1- interp) * (a + b) * Math.cos(freq) - b * Math.cos((a / b + 1)*freq) +
							    interp * revx + WIDTH/2;
							y = ((1- interp) * a + b) * Math.sin(freq) - b * Math.sin((a / b + 1)*freq) + 
							    interp * revy + HEIGHT/2;
							r = Math.abs(Math.pow(amp/SAMPLE_MAX, 2)) * 50; 
						break;
						case GridMode.REVERSEEPIC:
							var rev = 1024 - freq;
							var a = rev/1024 * 200;
							var b = a/7; 
							var c = 100;
							x = (a + b) * Math.cos(rev) - b * Math.cos((a / b + 1)*rev) + WIDTH/2;
							y = (a + b) * Math.sin(rev) - b * Math.sin((a / b + 1)*rev) + HEIGHT/2;
							r = Math.abs(Math.pow(amp/SAMPLE_MAX, 2)) * 50; 
						break;
						case GridMode.HYPOTROCHOID:
							var a = freq/1024 * 200;
							var b = a/7; 
							var c = 150;
							x = (a - b) * Math.cos(freq) - c * Math.cos((a / b - 1)*freq) + WIDTH/2;
							y = (a - b) * Math.sin(freq) - c * Math.sin((a / b - 1)*freq) + HEIGHT/2;
							r = Math.abs(Math.pow(amp/SAMPLE_MAX, 2)) * 50; 
						break;
						default:
							x = Math.floor(freq % GRID_WIDTH) * WIDTH/GRID_WIDTH + 10;
							y = Math.floor(freq / GRID_WIDTH) * HEIGHT/GRID_HEIGHT + 10;
							r = Math.abs(amp/SAMPLE_MAX) * 30;	
					}

					
					var lastamp = lastAmps[freq];
					var delta = (lastamp - amp);
					
					switch (colormode) {
						case ColorMode.MONOCHROME:
							ctxt.fillStyle = 'rgba(0, 255, 0,' + r/30 * 0.9 + ')';
						break;					
						case ColorMode.TWOTONE:
							if (delta > 1) {
								ctxt.fillStyle = 'rgba(0 ,0, 255,' + r/30 * 0.9 + ')';
							}
							else {
								ctxt.fillStyle = 'rgba(0, 255, 0,' + r/30 * 0.9 + ')';
							}
						break;					
						case ColorMode.THREETONE:
							if (delta > 1) {
								ctxt.fillStyle = 'rgba(0 ,0, 255,' + r/30 * 0.9 + ')';
							}
							else if (delta < -1) {
								ctxt.fillStyle = 'rgba(255, 255, 0,' + r/30 * 0.9 + ')';
							}
							else {
								ctxt.fillStyle = 'rgba(0, 255, 0,' + r/30 * 0.9 + ')';

							}
						break;					
						case ColorMode.GRADIENT:
							ctxt.fillStyle = 'rgba(' + + ' , ' +  +  ' , ' + +  ' , ' + r/30 * 0.9 + ')';
						break;
						case ColorMode.RANDOM:
							var red = Math.random() * 255;
							var green= Math.random() * 255;
							var blue = Math.random() * 255;
							var a = r/30 * 0.9;	
						//	ctxt.fillStyle = 'rgba(' + red + ',' + green + ',' + blue + ', 1)';
							ctxt.fillStyle = 'rgba('+ red + ','+ green + ',' + blue + ',' + r/30 * 0.9 + ')';
							break;	
						default:
							ctxt.fillStyle = 'rgba(0, 255, 0,' + r/30 * 0.9 + ')';
					}

					switch (shapemode) {
						case ShapeMode.CIRCLE:
							ctxt.beginPath();
							ctxt.arc(x, y, r, 0, Math.PI * 2);
							ctxt.fill();
						break;	
						case ShapeMode.SQUARE:
							ctxt.beginPath();
							ctxt.rotate(frame % 2 * Math.PI);
							ctxt.rect(x - r, y-r, r * 2, r * 2);
							ctxt.fill();
						break;	
						case ShapeMode.SKEW:
							ctxt.beginPath();
							ctxt.arc(x, y, r, 0, Math.PI * 2);
							ctxt.fill();
						break;	
						default:
							ctxt.beginPath();
							ctxt.arc(x, y, r, 0, Math.PI * 2);
							ctxt.fill();
					}
				}

				lastAmps = freqDomain;
				frame++;
			}

			// play sound from ArrayBuffer
			function playSound(buffer) {
				// disconnect if there is already a song uploaded
				if (audioSource) {
					audioSource.stop();
					audioSource.disconnect(0);
				}
				
				audioSource = audioContext.createBufferSource();
				
				try {
					audioSource.buffer = audioContext.createBuffer(buffer,false);
				} catch (e) {
					console.log("error reading sound file");
					return;
				}				
				
				$('h1').hide();
				$('#dragDiv').hide();
				$('#canvas').show();
				$('#wavedistortion').show();
				$('#controls').hide();	
				console.log('colormode = ' + colormode);
				console.log('gridmode = ' + gridmode);
				// set up the AudioAnalserNode
				analyser = audioContext.createAnalyser();
				audioSource.connect(analyser);

				lastAmps = new Float32Array(analyser.frequencyBinCount);

				analyser.connect(audioContext.destination);
				audioSource.connect(audioContext.destination);
		 
				audioSource.start(0);
				analyzeSound();
			}		
			
			function allowDrop(ev) {
//				console.log('registered drag');
				ev.preventDefault();
			}
			
			function drop(ev) {
				ev.preventDefault();
				var data = ev.dataTransfer.files[0];	
				if (data) {
					loadSound(data);
				}
			}

			$(document).ready(function() {

				init();

			$(".colormode").change(function () {
				colormode = parseInt(this.value);
				console.log('colormode = ' + colormode);
			});

			$('.gridmode').change(function () {
				gridmode = parseInt(this.value);
				console.log('gridmode = ' + gridmode);
			});
			$('.shapemode').change(function () {
				shapemode = parseInt(this.value);
				console.log('shapemode = ' + shapemode);
			});
			$('#wavedistortion').change(function () {
				interp = $(this).val();
				console.log(this);
				console.log('interp updated to ' + interp);
			});
			});	
		</script>
	</head>

	<body>
		<h1>Sound Scene</h1>
		<div id="dragDiv" ondragover="allowDrop(event)" ondrop="drop(event)"><span> drag sound here </span></div>
		<input type ='range' id='wavedistortion' name = "distortion" min="0" max ="1" step = "0.01" value="0">DISTORT</input>
		<canvas id="canvas"></canvas>

		<div id='controls'>
		<p>//TEMPORARY CONTROLS</p>
		<p>Shape Mode: </p>
		<input type='radio' class='shapemode' name='shapemode' value='0'> CIRCLE </input>
		<br></br>
		<input type='radio' class='shapemode' name='shapemode' value='1'> SQUARE </input>
		<br></br>
		<p>Color Mode: </p>
		<input type='radio' class='colormode' name='colormode' value='0'> MONOCHROME </input>
		<br></br>
		<input type='radio' class='colormode' name='colormode' value='1'> TWOTONE </input>
		<br></br>
		<input type='radio' class='colormode'  name='colormode' value='2'> THREETONE </input>

		<p>Grid Mode: </p>
		<input type='radio'  class='gridmode' name='gridmode' value='0'> RIGID </input>
		<br></br>
		<input type='radio'  class='gridmode'  name='gridmode' value='1'> CONCENTRIC </input>
		<br></br>
		<input type='radio'  class='gridmode'   name='gridmode' value='2'> RANDOM </input>
		<br></br>
		<input type='radio'  class='gridmode'  name='gridmode' value='3'> SPIRAL </input>
		<br></br>
		<input type='radio'  class='gridmode'  name='gridmode' value='4'> REVERSE SPIRAL </input>
		<br></br>
		<input type='radio'  class='gridmode'   name='gridmode' value='5'> BUTTERFLY </input>
		<br></br>
		<input type='radio'  class='gridmode'  name='gridmode' value='6'> ASTROID </input>
		<br></br>
		<input type='radio'  class='gridmode'  name='gridmode' value='7'> EPICYCLOID </input>
		<br></br>
		<input type='radio'  class='gridmode'   name='gridmode' value='8'> REVERSE EPICYCLOID </input>
		<br></br>
		<input type='radio'  class='gridmode'  name='gridmode' value='9'> HYPOTROCHOID </input>
		<br></br>
		</div>
</body>
</html>
