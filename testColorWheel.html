<html>
	<head>
		<script src="js/jquery-1.11.0.min.js"></script>
		<style>	
			.marker {
				position:absolute;
				width:10px;
				height:10px;
				border-radius:10px;
				border:2px solid black;
			}
	
			#canvas {

				position:fixed;
				top:0px;
				left:0px;
			}
		</style>
		<script type="text/javascript">
			var markers = [];
			var canvas;
			var ctxt;
			var width = 200;
			var height = 200;
			var startX = 100;
			var startY = 100;
			var markerRad = 10;
			var selectedmark = -1;
			var mdx;
			var mdy;

			function markerIndex(x, y) {
				var index = -1;
				for (var i = 0; i < markers.length; i++) {
					var marker = markers[i];
					var px = marker.x;
					var py = marker.y;	

					var check = Math.pow(x - px, 2) + Math.pow(y - py, 2);
					if (check < Math.pow(markerRad, 2)) {
						index = i;
						break;
					}	
				}

				return index;
			}

			function drawMarkers(){ 
				ctxt.clearRect(0, 0, width, height); 
				ctxt.drawImage(colorwheel,startX, startY, width, height);			

				for(var i = 0; i < markers.length; i++) {
					ctxt.beginPath();
					var marker = markers[i];
					ctxt.strokeStyle = "#FFFFFF";
					
					if (selectedmark == i) {
						ctxt.lineWidth = 5;
					}
					else {
						ctxt.lineWidth = 3;
					}

					var px = marker.x;
					var py = marker.y;
				
					var imgData = ctxt.getImageData(px, py, 1, 1).data;
					var r = imgData[0];					
					var g = imgData[1];					
					var b = imgData[2];					
					var a = imgData[3];

					ctxt.fillStyle = "rgba( " + r + " , " +  g + " , " +  b + " , " + a + " )";
					ctxt.arc(px, py, markerRad, 0, Math.PI * 2);	
					ctxt.stroke();
					ctxt.fill();
				}
			}

			$(document).ready(function(){
				for (var i = 0; i < 3; i++) {
					var x = startX + width/2 + 90 * Math.cos(-Math.PI/4 * i);
					var y = startX + width/2 + 90 * Math.sin(-Math.PI/4 * i);

					var next = {x:x, y:y};
					markers[i] = next;	
				}

				canvas = document.getElementById("canvas");


				canvas.width = 500;
				canvas.height = 500; 
				ctxt = canvas.getContext("2d");
				ctxt.strokeStyle = "#000000";

				$("#colorwheel").hide();	
				var colorwheel = document.getElementById("colorwheel");
				colorwheel.onload = function() {
					drawMarkers();
				}

				$("#canvas").mousedown(function(ev) {
					var x = ev.pageX;
					var y = ev.pageY;
					selectedmark = markerIndex(x, y);
				});

				$("#canvas").mouseup(function(ev) {
					selectedmark = -1;
					drawMarkers();
				});
				

				$("#canvas").mousemove(function(ev) {
					if (selectedmark != -1) {
						var marker = markers[selectedmark];
						
						var ux = ev.pageX;
						var uy = ev.pageY;	
	
						var oldx = marker.x;
						var oldy = marker.y;

						var radius = width/2 - markerRad;
						var ax = ux - (startX + width/2);
						var ay = uy - (startY + width/2);
						var currRadius = Math.sqrt(Math.pow(ax, 2) + Math.pow(ay, 2));
						var boundscheck = Math.pow(ux - (startX + width/2), 2) + Math.pow(uy - (startY + width/2),2);
	
						if (boundscheck < Math.pow(width/2 - markerRad, 2)) {
							marker.x = ux;
							marker.y = uy;
						}
						else {
							marker.x = startX + width/2 + radius * ax/currRadius;
							marker.y = startY + width/2 + radius * ay/currRadius; 
						}
	
	
						switch(selectedmark) {
							case -1:
							return;
							break;

							// complementary color
							case 0:
								var complement = markers[2];
								var dx = oldx - marker.x;
								var dy = oldy - marker.y;
								var offsetx = startX + width/2;
								var offsety = startY + width/2;
								var da = Math.atan2(oldy - offsety, oldx - offsetx) -
								 	 Math.atan2(marker.y - offsety, marker.x - offsetx); 

								console.log("da = " + (da * 180 / Math.PI));	
								var oldR = Math.sqrt(Math.pow(oldx - offsetx, 2) + 
									   Math.pow(oldy-offsety, 2));
								var dr = Math.min(width/2, currRadius) - oldR;	
								var cx = complement.x - offsetx;
								var cy = complement.y - offsety;
								var r = Math.sqrt(Math.pow(cx, 2) + Math.pow(cy, 2));
								
								// r += dr;
								var angle = Math.atan2(cy, cx);
								angle += da;	
	
								complement.x = offsetx + r * Math.cos(angle);
								complement.y = offsety + r * Math.sin(angle);
								/*complement.x = complement.x * Math.cos(da) 
										- complement.y * Math.sin(da);
								complement.y = complement.x * Math.sin(da) + 
										complement.y * Math.cos(da);*/
								
							break;
						
							// base color
							case 1:
								var oldR = Math.sqrt(Math.pow(oldx - (startX + width/2), 2) + 
									   Math.pow(oldy-(startY + width/2), 2));
								var dr = Math.min(width/2, currRadius) - oldR;	

								var c1 = markers[0];
								var c2 = markers[2];

								var c1x = c1.x - (startX + width/2);
								var c1y = c1.y - (startY + width/2);

								var c2x = c2.x - (startX + width/2);
								var c2y = c2.y - (startY + width/2);

								var r1 = Math.sqrt(Math.pow(c1x, 2) + Math.pow(c1y, 2));
								var r2 = Math.sqrt(Math.pow(c2x, 2) + Math.pow(c2y, 2));

								if (r1 + dr < (width/2 - markerRad)) {
									c1.x += dr * c1x/r1;
									c1.y += dr * c1y/r1;

								}

								if (r2 + dr < (width/2 - markerRad)) {
									c2.x += dr * c2x/r2;
									c2.y += dr * c2y/r2;
								}
							break;
							
							// complementary color
							case 2:
							break;	
							
							default:
							break;
						}
					}

					drawMarkers();
				});

			});
		</script>
	</head>
	<body>
		<canvas id = "canvas" ondragover="allowDrop(event)" ondrop="onDrop(event)"> </canvas>
		<img src="images/colorwheel.png" id="colorwheel"></img>
	</body>
</html>

